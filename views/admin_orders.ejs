<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Orders</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="/css/admnProducts.css">
  <style>
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .stat-label {
      color: #64748b;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #1e293b;
    }

    .status-badge {
      display: inline-block;
      padding: 0.35rem 0.75rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .status-shipped {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-delivered {
      background: #d1fae5;
      color: #065f46;
    }

    .edit-btn, .delete-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-right: 0.5rem;
      transition: all 0.2s;
    }

    .edit-btn {
      background: #3b82f6;
      color: white;
    }

    .edit-btn:hover {
      background: #2563eb;
    }

    .delete-btn {
      background: #ef4444;
      color: white;
    }

    .delete-btn:hover {
      background: #dc2626;
    }

    .modal-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .modal h3 {
      margin-bottom: 1rem;
      color: #1e293b;
    }

    .modal label {
      display: block;
      margin-bottom: 0.5rem;
      color: #334155;
      font-weight: 500;
    }

    .modal select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .modal-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      margin-top: 1.5rem;
    }

    .btn-cancel {
      background: #f1f5f9;
      color: #475569;
    }

    .btn-cancel:hover {
      background: #e2e8f0;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 2000;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification.success {
      background: #d1fae5;
      color: #065f46;
      border-left: 4px solid #10b981;
    }

    .notification.error {
      background: #fee2e2;
      color: #991b1b;
      border-left: 4px solid #ef4444;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .empty-state-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 0.5rem;
    }

    .empty-state-text {
      color: #64748b;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar mobile-hidden" id="sidebar">
      <div class="brand">
        <span class="logo" aria-hidden="true"></span>
        <div>
          <div class="title">EASY SHOP Admin <span class="pro"></span></div>
          <div class="muted" style="font-size:0.85rem;margin-top:4px">Manage your store</div>
        </div>
      </div>

      <nav class="side-nav" aria-label="Main navigation">
        <a href="/admin/dashboard"><span class="icon"><i class="fa-solid fa-tachometer-alt"></i></span> Dashboard</a>
        <a href="/admin/products"><span class="icon"><i class="fa-solid fa-box"></i></span> Products</a>
        <a href="/admin/orders" class="active"><span class="icon"><i class="fa-solid fa-cart-shopping"></i></span> Orders</a>
        <a href="/admin/users"><span class="icon"><i class="fa-solid fa-users"></i></span> Users</a>
      </nav>

      <div class="sidebar-footer">
        Â© <span id="year"></span> EASY SHOP
      </div>
    </aside>

    <!-- MAIN -->
    <div class="main-wrap">
      <header class="topbar">
        <div class="top-left">
          <button class="hamburger" id="hamburger" title="Open menu">
            <i class="fa-solid fa-bars"></i>
          </button>
          <div class="heading">
            <div class="brand">EASY SHOP Admin</div>
            <div class="subtitle muted">Orders</div>
          </div>
        </div>

        <div class="top-actions">
          <div class="search-field" role="search" aria-label="Search">
            <i class="fa-solid fa-magnifying-glass muted"></i>
            <input type="search" id="searchInput" placeholder="Search orders..." />
          </div>
          <a href="/logout" class="btn-logout">Logout</a>
        </div>
      </header>

      <main>
        <!-- Stats Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total Orders</div>
            <div class="stat-value"><%= orders.length %></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Pending</div>
            <div class="stat-value"><%= orders.filter(o => o.status === 'Pending').length %></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Shipped</div>
            <div class="stat-value"><%= orders.filter(o => o.status === 'Shipped').length %></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Delivered</div>
            <div class="stat-value"><%= orders.filter(o => o.status === 'Delivered').length %></div>
          </div>
        </div>

        <!-- Orders Table -->
        <div class="table-box">
          <div class="header page-header">
            <div style="display:flex;align-items:center;gap:12px">
              <div class="page-title">All Orders</div>
              <div class="muted" style="font-size:0.9rem">Order management</div>
            </div>
          </div>

          <div style="padding:16px; overflow-x:auto;">
            <% if (orders.length > 0) { %>
            <table id="ordersTable">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Customer ID</th>
                  <th>Total</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% orders.forEach(o => { %>
                <tr data-order-id="<%= o.id %>">
                  <td>#<%= o.id %></td>
                  <td><%= o.customer_id %></td>
                  <td class="order-total">MK <%= parseFloat(o.total).toFixed(2) %></td>
                  <td>
                    <span class="status-badge status-<%= o.status.toLowerCase() %>">
                      <%= o.status %>
                    </span>
                  </td>
                  <td class="actions">
                    <button
                      class="edit-btn"
                      type="button"
                      data-id="<%= o.id %>"
                      data-status="<%= o.status %>"
                    >
                      Update Status
                    </button>
                    <button
                      class="delete-btn"
                      type="button"
                      data-id="<%= o.id %>"
                    >
                      Delete
                    </button>
                  </td>
                </tr>
                <% }) %>
              </tbody>
            </table>
            <% } else { %>
            <div class="empty-state">
              <div class="empty-state-icon">ðŸ“¦</div>
              <div class="empty-state-title">No Orders Yet</div>
              <p class="empty-state-text">Orders will appear here once customers start placing them.</p>
            </div>
            <% } %>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Update Status Modal -->
  <div id="editBackdrop" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document" aria-labelledby="editTitle">
      <h3 id="editTitle">Update Order Status</h3>
      <form id="editForm">
        <div class="grid">
          <div style="grid-column: 1 / -1;">
            <label for="editStatus">Order Status</label>
            <select id="editStatus" name="status" required>
              <option value="Pending">Pending</option>
              <option value="Shipped">Shipped</option>
              <option value="Delivered">Delivered</option>
            </select>
          </div>
        </div>

        <input type="hidden" id="editOrderId" name="orderId" />

        <div class="modal-actions">
          <button type="button" class="btn btn-cancel" id="editCancel">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Status</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Modal -->
  <div id="deleteBackdrop" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document" aria-labelledby="deleteTitle">
      <h3 id="deleteTitle">Confirm Delete</h3>
      <p id="deleteMsg" style="color:#475569;margin-top:6px">Are you sure you want to delete this order?</p>

      <div class="modal-actions" style="margin-top:16px;">
        <button type="button" class="btn btn-cancel" id="deleteCancel">Cancel</button>
        <button type="button" class="btn btn-danger" id="deleteConfirm">Yes, delete</button>
      </div>
    </div>
  </div>

  <!-- Notification Toast -->
  <div id="notification" class="notification" style="display:none;">
    <span id="notificationMessage"></span>
  </div>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    const sidebar = document.getElementById('sidebar');
    const hamburger = document.getElementById('hamburger');
    hamburger.addEventListener('click', () => {
      if (sidebar.classList.contains('mobile-hidden')) {
        sidebar.classList.remove('mobile-hidden');
        sidebar.style.position = 'fixed';
        sidebar.style.left = '12px';
        sidebar.style.top = '12px';
        sidebar.style.zIndex = 60;
        sidebar.style.height = 'calc(100vh - 24px)';
      } else {
        sidebar.classList.add('mobile-hidden');
        sidebar.style.position = '';
        sidebar.style.left = '';
        sidebar.style.top = '';
        sidebar.style.zIndex = '';
      }
    });

    function handleResize() {
      if (window.innerWidth > 1000) {
        sidebar.classList.remove('mobile-hidden');
        sidebar.style.position = 'sticky';
      } else {
        sidebar.classList.add('mobile-hidden');
      }
    }
    window.addEventListener('resize', handleResize);
    handleResize();

    const searchInput = document.getElementById('searchInput');
    const tableRows = document.querySelectorAll('#ordersTable tbody tr');

    if (searchInput && tableRows.length > 0) {
      searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase();
        tableRows.forEach(row => {
          const rowText = row.textContent.toLowerCase();
          row.style.display = rowText.includes(query) ? '' : 'none';
        });
      });
    }

    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      const messageEl = document.getElementById('notificationMessage');
      
      messageEl.textContent = message;
      notification.className = `notification ${type}`;
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }

    const editBackdrop = document.getElementById('editBackdrop');
    const deleteBackdrop = document.getElementById('deleteBackdrop');
    const editForm = document.getElementById('editForm');
    const editStatus = document.getElementById('editStatus');
    const editOrderId = document.getElementById('editOrderId');
    const editCancel = document.getElementById('editCancel');
    const deleteMsg = document.getElementById('deleteMsg');
    const deleteCancel = document.getElementById('deleteCancel');
    const deleteConfirm = document.getElementById('deleteConfirm');

    let currentDeleteId = null;

    function showModal(backdrop) {
      backdrop.style.display = 'flex';
      backdrop.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }
    
    function hideModal(backdrop) {
      backdrop.style.display = 'none';
      backdrop.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }

    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const status = btn.dataset.status || 'Pending';
        editStatus.value = status;
        editOrderId.value = id;
        showModal(editBackdrop);
      });
    });

    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const orderId = editOrderId.value;
      const status = editStatus.value;
      
      try {
        const response = await fetch(`/admin/orders/update/${orderId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ status })
        });

        const result = await response.json();

        if (response.ok) {
          showNotification('Order status updated successfully!', 'success');
          hideModal(editBackdrop);
          setTimeout(() => window.location.reload(), 1000);
        } else {
          showNotification(result.error || 'Failed to update order', 'error');
        }
      } catch (error) {
        showNotification('Error updating order', 'error');
        console.error('Error:', error);
      }
    });

    editCancel.addEventListener('click', () => hideModal(editBackdrop));
    editBackdrop.addEventListener('click', (e) => {
      if (e.target === editBackdrop) hideModal(editBackdrop);
    });

    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        currentDeleteId = btn.dataset.id;
        deleteMsg.textContent = `Are you sure you want to permanently delete order #${currentDeleteId}? This action cannot be undone.`;
        showModal(deleteBackdrop);
      });
    });

    deleteConfirm.addEventListener('click', async () => {
      if (!currentDeleteId) return;

      try {
        const response = await fetch(`/admin/orders/delete/${currentDeleteId}`, {
          method: 'POST'
        });

        const result = await response.json();

        if (response.ok) {
          showNotification('Order deleted successfully!', 'success');
          hideModal(deleteBackdrop);
          
          const row = document.querySelector(`tr[data-order-id="${currentDeleteId}"]`);
          if (row) {
            row.style.transition = 'opacity 0.3s ease';
            row.style.opacity = '0';
            setTimeout(() => {
              row.remove();
              if (document.querySelectorAll('#ordersTable tbody tr').length === 0) {
                window.location.reload();
              }
            }, 300);
          }
          
          currentDeleteId = null;
        } else {
          showNotification(result.error || 'Failed to delete order', 'error');
        }
      } catch (error) {
        showNotification('Error deleting order', 'error');
        console.error('Error:', error);
      }
    });

    deleteCancel.addEventListener('click', () => {
      hideModal(deleteBackdrop);
      currentDeleteId = null;
    });
    
    deleteBackdrop.addEventListener('click', (e) => {
      if (e.target === deleteBackdrop) {
        hideModal(deleteBackdrop);
        currentDeleteId = null;
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (editBackdrop.style.display === 'flex') hideModal(editBackdrop);
        if (deleteBackdrop.style.display === 'flex') {
          hideModal(deleteBackdrop);
          currentDeleteId = null;
        }
      }
    });
  </script>
</body>
</html>